<!-- â€¦ (todo tu cÃ³digo actual sin cambios, hasta antes del cierre </script>) -->

<!-- === NUEVO: CONEXIÃ“N SUPABASE + IA === -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://dbpqhxvgmzggfrzkhcgi.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRicHFoeHZnbXpnZ2ZyemtoY2dpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjc4NjUsImV4cCI6MjA3Nzg0Mzg2NX0.ndtpkjrJnQ8MgkOYR1eJnjyP2C1czwUmMOol3bzR8uM";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Obtiene datos del asesor logueado
  const session = JSON.parse(localStorage.getItem("calidad_session") || "{}");

  // ðŸ”¹ Cuando se finaliza la conversaciÃ³n, guardamos y enviamos evaluaciÃ³n
  async function guardarConversacion() {
    const mensajes = [...document.querySelectorAll('.msg')].map(m => {
      const rol = m.classList.contains('asesor') ? 'Asesor' : 'Cliente';
      return `${rol}: ${m.textContent.replace(/^ðŸ‘¤ Asesor: |^ðŸ¤– Cliente: /, '')}`;
    }).join('\n');

    if (!mensajes) {
      alert("No hay conversaciÃ³n para guardar.");
      return;
    }

    // Mostrar aviso al usuario
    alert("ðŸ“¤ Enviando conversaciÃ³n a Calidad IA...");

    try {
      // Guarda en Supabase
      const { data, error } = await supabase
        .from("evaluaciones")
        .insert([{
          asesor_dni: session.dni || '',
          asesor_nombre: session.nombre || '',
          cartera: session.cartera || '',
          conversacion: mensajes
        }])
        .select()
        .single();

      if (error) throw error;

      // Llamar a OpenAI para evaluaciÃ³n automÃ¡tica
      const resumen = await evaluarConversacion(mensajes);
      const puntaje = resumen?.totalScore || 0;

      // Actualiza registro con resultado
      await supabase
        .from("evaluaciones")
        .update({
          puntaje_total: puntaje,
          resumen_json: resumen
        })
        .eq("id", data.id);

      alert("âœ… EvaluaciÃ³n completada. Puntaje: " + puntaje);

    } catch (err) {
      console.error("Error al guardar conversaciÃ³n:", err);
      alert("âŒ Error al guardar conversaciÃ³n.");
    }
  }

  // ðŸ”¹ FunciÃ³n que llama a la IA de OpenAI para evaluar
  async function evaluarConversacion(texto) {
    try {
      const r = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + OPENAI_API_KEYS[0]
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [
            {
              role: "system",
              content: "Eres un analista de calidad de cobranzas. EvalÃºa la conversaciÃ³n segÃºn saludo, validaciÃ³n de identidad, negociaciÃ³n, cierre y tÃ©cnicas. Devuelve un JSON con totalScore (0â€“100) y observaciones."
            },
            { role: "user", content: texto }
          ]
        })
      });

      const data = await r.json();
      const content = data.choices?.[0]?.message?.content || "{}";
      return JSON.parse(content);
    } catch (e) {
      console.error("Error evaluando IA:", e);
      return { totalScore: 0, error: true };
    }
  }

  // ðŸ”¹ Conecta botÃ³n para guardar
  const stopBtn = document.getElementById("micStop");
  stopBtn.addEventListener("click", () => {
    setTimeout(guardarConversacion, 1500);
  });
</script>
<!-- === FIN DE BLOQUE NUEVO === -->
</body>
</html>
